{"version":3,"file":"structuredData.esm.js","sources":["../../src/signature/structuredData.ts"],"sourcesContent":["import { bytesToHex } from '@stacks/common';\nimport { serializeCV } from '@stacks/transactions';\nimport { createUnsecuredToken, TokenSigner } from 'jsontokens';\nimport { getDefaultSignatureRequestOptions } from '.';\nimport { getKeys, hasAppPrivateKey } from '../transactions';\nimport {\n  StructuredDataSignatureOptions,\n  StructuredDataSignaturePayload,\n  StructuredDataSignaturePopup,\n  StructuredDataSignatureRequestOptions,\n} from '../types/structuredDataSignature';\nimport { getStacksProvider } from '../utils';\n\nasync function generateTokenAndOpenPopup<T extends StructuredDataSignatureOptions>(\n  options: T,\n  makeTokenFn: (options: T) => Promise<string>\n) {\n  const token = await makeTokenFn({\n    ...getDefaultSignatureRequestOptions(options),\n    ...options,\n  } as T);\n  return openStructuredDataSignaturePopup({ token, options });\n}\n\nasync function signPayload(payload: StructuredDataSignaturePayload, privateKey: string) {\n  const tokenSigner = new TokenSigner('ES256k', privateKey);\n  return tokenSigner.signAsync({\n    ...payload,\n    message: bytesToHex(serializeCV(payload.message)),\n    domain: bytesToHex(serializeCV(payload.domain)),\n  } as any);\n}\n\nexport async function signStructuredMessage(options: StructuredDataSignatureRequestOptions) {\n  const { userSession, ..._options } = options;\n  if (hasAppPrivateKey(userSession)) {\n    const { privateKey, publicKey } = getKeys(userSession);\n\n    const payload: StructuredDataSignaturePayload = {\n      ..._options,\n      publicKey,\n    };\n    return signPayload(payload, privateKey);\n  }\n  // Type casting `any` as payload contains non-serialisable content,\n  // such as `StacksNetwork`\n  return createUnsecuredToken(options as any);\n}\n\nasync function openStructuredDataSignaturePopup({ token, options }: StructuredDataSignaturePopup) {\n  const provider = getStacksProvider();\n  if (!provider) {\n    throw new Error('Hiro Wallet not installed.');\n  }\n\n  try {\n    const signatureResponse = await provider.structuredDataSignatureRequest(token);\n\n    options.onFinish?.(signatureResponse);\n  } catch (error) {\n    console.error('[Connect] Error during signature request', error);\n    options.onCancel?.();\n  }\n}\n\nexport function openStructuredDataSignatureRequestPopup(\n  options: StructuredDataSignatureRequestOptions\n) {\n  return generateTokenAndOpenPopup(options, signStructuredMessage);\n}\n"],"names":["options","makeTokenFn","getDefaultSignatureRequestOptions","token","openStructuredDataSignaturePopup","payload","privateKey","tokenSigner","TokenSigner","signAsync","message","bytesToHex","serializeCV","domain","userSession","_options","hasAppPrivateKey","getKeys","publicKey","signPayload","createUnsecuredToken","provider","getStacksProvider","Error","structuredDataSignatureRequest","signatureResponse","onFinish","error","onCancel","generateTokenAndOpenPopup","signStructuredMessage"],"mappings":";;;;;;;;;;;;;;;;wFAaA,iBACEA,OADF,EAEEC,WAFF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAIsBA,yBACfC,kCAAkCF,UAClCA,SANP;;AAAA;AAIQG,YAAAA,KAJR;AAAA,6CAQSC,iCAAiC;AAAED,cAAAA,OAAAA,KAAF;AAASH,cAAAA,SAAAA;AAAT,cAR1C;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;0EAWA,kBAA2BK,OAA3B,EAAoEC,UAApE;AAAA;AAAA;AAAA;AAAA;AAAA;AACQC,YAAAA,WADR,GACsB,IAAIC,WAAJ,CAAgB,QAAhB,EAA0BF,UAA1B,CADtB;AAAA,8CAESC,YAAYE,SAAZ,cACFJ,OADE;AAELK,cAAAA,SAASC,WAAWC,YAAYP,QAAQK,SAFnC;AAGLG,cAAAA,QAAQF,WAAWC,YAAYP,QAAQQ;AAHlC,eAFT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;8BASA;AAAA;AAAA;;;sGAA4Cb;;;;;;;AAClCc,YAAAA,cAA6Bd,QAA7Bc,aAAgBC,yCAAaf;;iBACjCgB,iBAAiBF;;;;;uBACeG,QAAQH,cAAlCR,sBAAAA,YAAYY,qBAAAA;AAEdb,YAAAA,uBACDU;AACHG,cAAAA,WAAAA;;8CAEKC,YAAYd,SAASC;;;8CAIvBc,qBAAqBpB;;;;;;;;;;;;;;;;;+FAG9B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAkDG,YAAAA,KAAlD,QAAkDA,KAAlD,EAAyDH,OAAzD,QAAyDA,OAAzD;AACQqB,YAAAA,QADR,GACmBC,mBADnB;;AAAA,gBAEOD,QAFP;AAAA;AAAA;AAAA;;AAAA,kBAGU,IAAIE,KAAJ,CAAU,4BAAV,CAHV;;AAAA;AAAA;AAAA;AAAA,mBAOoCF,SAASG,8BAAT,CAAwCrB,KAAxC,CAPpC;;AAAA;AAOUsB,YAAAA,iBAPV;oBASYC,oCAAAA,SAAWD;AATvB;AAAA;;AAAA;AAAA;AAAA;oBAWYE,MAAM;oBACNC,oCAAAA;;AAZZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;iDAiBE5B,SACA;SACO6B,0BAA0B7B,SAAS8B;;;;;"}