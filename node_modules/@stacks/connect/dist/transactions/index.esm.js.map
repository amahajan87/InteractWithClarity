{"version":3,"file":"index.esm.js","sources":["../../src/transactions/index.ts"],"sourcesContent":["import { AppConfig, UserSession } from '@stacks/auth';\nimport { bytesToHex, hexToBytes } from '@stacks/common';\nimport { StacksTestnet } from '@stacks/network';\nimport {\n  ChainID,\n  deserializeTransaction,\n  PostCondition,\n  serializeCV,\n  serializePostCondition,\n} from '@stacks/transactions';\nimport { createUnsecuredToken, Json, SECP256K1Client, TokenSigner } from 'jsontokens';\nimport {\n  ContractCallOptions,\n  ContractCallPayload,\n  ContractCallRegularOptions,\n  ContractCallSponsoredOptions,\n  ContractDeployOptions,\n  ContractDeployPayload,\n  ContractDeployRegularOptions,\n  ContractDeploySponsoredOptions,\n  FinishedTxPayload,\n  SponsoredFinishedTxPayload,\n  STXTransferOptions,\n  STXTransferPayload,\n  STXTransferRegularOptions,\n  STXTransferSponsoredOptions,\n  TransactionOptions,\n  TransactionPayload,\n  TransactionPopup,\n  TransactionTypes,\n} from '../types/transactions';\nimport { getStacksProvider } from '../utils';\n\n// TODO extract out of transactions\nexport const getUserSession = (_userSession?: UserSession) => {\n  let userSession = _userSession;\n\n  if (!userSession) {\n    const appConfig = new AppConfig(['store_write'], document.location.href);\n    userSession = new UserSession({ appConfig });\n  }\n  return userSession;\n};\n\nexport function hasAppPrivateKey(userSession?: UserSession) {\n  try {\n    const session = getUserSession(userSession).loadUserData();\n    return session.appPrivateKey;\n  } catch (e) {\n    return false;\n  }\n}\n\nexport const getKeys = (_userSession?: UserSession) => {\n  const userSession = getUserSession(_userSession);\n  const privateKey = userSession.loadUserData().appPrivateKey;\n  const publicKey = SECP256K1Client.derivePublicKey(privateKey);\n\n  return { privateKey, publicKey };\n};\n\n// TODO extract out of transactions\nexport function getStxAddress(options: TransactionOptions) {\n  const { stxAddress, userSession, network } = options;\n\n  if (stxAddress) return stxAddress;\n  if (!userSession || !network) return undefined;\n  const stxAddresses = userSession?.loadUserData().profile?.stxAddress;\n  const chainIdToKey = {\n    [ChainID.Mainnet]: 'mainnet',\n    [ChainID.Testnet]: 'testnet',\n  };\n  const address: string | undefined = stxAddresses?.[chainIdToKey[network.chainId]];\n  return address;\n}\n\nfunction getDefaults(options: TransactionOptions) {\n  const network = options.network || new StacksTestnet();\n\n  // Legacy auth using localstorage with appPrivateKey\n  if (hasAppPrivateKey(options.userSession)) {\n    const userSession = getUserSession(options.userSession);\n    const defaults: TransactionOptions = {\n      ...options,\n      network,\n      userSession,\n    };\n\n    return {\n      stxAddress: getStxAddress(defaults),\n      ...defaults,\n    };\n  }\n\n  // User has not authed, we're relying on the app having previously having been\n  // given permissions from  `stx_requestAccounts`, and the wallet recognising the app's origin\n  // const hasSetRequiredStxAddressPropForRequestAccountFlow = 'stxAddress' in options;\n  // if (!hasSetRequiredStxAddressPropForRequestAccountFlow) {\n  //   throw new Error(\n  //     'Must set property `stxAddress` when using `stx_requestAccounts to initiate transaction`'\n  //   );\n  // }\n  return { ...options, network };\n}\n\nfunction encodePostConditions(postConditions: PostCondition[]) {\n  return postConditions.map(pc => bytesToHex(serializePostCondition(pc)));\n}\n\nasync function signPayload(payload: TransactionPayload, privateKey: string) {\n  let { postConditions } = payload;\n  if (postConditions && typeof postConditions[0] !== 'string') {\n    postConditions = encodePostConditions(postConditions as PostCondition[]);\n  }\n  const tokenSigner = new TokenSigner('ES256k', privateKey);\n  return tokenSigner.signAsync({ ...payload, postConditions } as any);\n}\n\nfunction createUnsignedTransactionPayload(payload: Partial<TransactionPayload>) {\n  let { postConditions } = payload;\n  if (postConditions && typeof postConditions[0] !== 'string') {\n    postConditions = encodePostConditions(postConditions as PostCondition[]);\n  }\n  return createUnsecuredToken({ ...payload, postConditions } as unknown as Json);\n}\n\nconst openTransactionPopup = async ({ token, options }: TransactionPopup) => {\n  const provider = getStacksProvider();\n  if (!provider) {\n    throw new Error('Hiro Wallet not installed');\n  }\n\n  try {\n    const txResponse = await provider.transactionRequest(token);\n    const { txRaw } = txResponse;\n    const txBytes = hexToBytes(txRaw.replace(/^0x/, ''));\n    const stacksTransaction = deserializeTransaction(txBytes);\n\n    if ('sponsored' in options && options.sponsored) {\n      options.onFinish?.({\n        ...(txResponse as SponsoredFinishedTxPayload),\n        stacksTransaction,\n      });\n      return;\n    }\n    options.onFinish?.({\n      ...(txResponse as FinishedTxPayload),\n      stacksTransaction,\n    });\n  } catch (error) {\n    console.error('[Connect] Error during transaction request', error);\n    options.onCancel?.();\n  }\n};\n\nexport const makeContractCallToken = async (options: ContractCallOptions) => {\n  const { functionArgs, appDetails, userSession, ..._options } = options;\n\n  const args: string[] = functionArgs.map(arg => {\n    if (typeof arg === 'string') {\n      return arg;\n    }\n    return bytesToHex(serializeCV(arg));\n  });\n  if (hasAppPrivateKey(userSession)) {\n    const { privateKey, publicKey } = getKeys(userSession);\n    const payload: ContractCallPayload = {\n      ..._options,\n      functionArgs: args,\n      txType: TransactionTypes.ContractCall,\n      publicKey,\n    };\n    if (appDetails) payload.appDetails = appDetails;\n    return signPayload(payload, privateKey);\n  }\n  const payload: Partial<ContractCallPayload> = {\n    ..._options,\n    functionArgs: args,\n    txType: TransactionTypes.ContractCall,\n  };\n  if (appDetails) payload.appDetails = appDetails;\n  return createUnsignedTransactionPayload(payload);\n};\n\nexport const makeContractDeployToken = async (options: ContractDeployOptions) => {\n  const { appDetails, userSession, ..._options } = options;\n  if (hasAppPrivateKey(userSession)) {\n    const { privateKey, publicKey } = getKeys(userSession);\n    const payload: ContractDeployPayload = {\n      ..._options,\n      publicKey,\n      txType: TransactionTypes.ContractDeploy,\n    };\n    if (appDetails) payload.appDetails = appDetails;\n    return signPayload(payload, privateKey);\n  }\n\n  const payload: Partial<ContractDeployPayload> = {\n    ..._options,\n    txType: TransactionTypes.ContractDeploy,\n  };\n  if (appDetails) payload.appDetails = appDetails;\n  return createUnsignedTransactionPayload(payload);\n};\n\nexport const makeSTXTransferToken = async (options: STXTransferOptions) => {\n  const { amount, appDetails, userSession, ..._options } = options;\n\n  if (hasAppPrivateKey(userSession)) {\n    const { privateKey, publicKey } = getKeys(userSession);\n    const payload: STXTransferPayload = {\n      ..._options,\n      amount: amount.toString(10),\n      publicKey,\n      txType: TransactionTypes.STXTransfer,\n    };\n    if (appDetails) payload.appDetails = appDetails;\n    return signPayload(payload, privateKey);\n  }\n\n  const payload: Partial<STXTransferPayload> = {\n    ..._options,\n    amount: amount.toString(10),\n    txType: TransactionTypes.STXTransfer,\n  };\n  if (appDetails) payload.appDetails = appDetails;\n  return createUnsignedTransactionPayload(payload);\n};\n\nasync function generateTokenAndOpenPopup<T extends TransactionOptions>(\n  options: T,\n  makeTokenFn: (options: T) => Promise<string>\n) {\n  const token = await makeTokenFn({\n    ...getDefaults(options),\n    ...options,\n  } as T);\n  return openTransactionPopup({ token, options });\n}\n\nexport function openContractCall(options: ContractCallRegularOptions): Promise<void>;\nexport function openContractCall(options: ContractCallSponsoredOptions): Promise<void>;\nexport function openContractCall(options: ContractCallOptions): Promise<void>;\nexport function openContractCall(options: ContractCallOptions) {\n  return generateTokenAndOpenPopup(options, makeContractCallToken);\n}\n\nexport function openContractDeploy(options: ContractDeployRegularOptions): Promise<void>;\nexport function openContractDeploy(options: ContractDeploySponsoredOptions): Promise<void>;\nexport function openContractDeploy(options: ContractDeployOptions): Promise<void>;\nexport function openContractDeploy(options: ContractDeployOptions) {\n  return generateTokenAndOpenPopup(options, makeContractDeployToken);\n}\n\nexport function openSTXTransfer(options: STXTransferRegularOptions): Promise<void>;\nexport function openSTXTransfer(options: STXTransferSponsoredOptions): Promise<void>;\nexport function openSTXTransfer(options: STXTransferOptions): Promise<void>;\nexport function openSTXTransfer(options: STXTransferOptions) {\n  return generateTokenAndOpenPopup(options, makeSTXTransferToken);\n}\n"],"names":["getUserSession","_userSession","userSession","appConfig","AppConfig","document","location","href","UserSession","session","loadUserData","appPrivateKey","e","getKeys","privateKey","publicKey","SECP256K1Client","derivePublicKey","options","stxAddress","network","stxAddresses","profile","chainIdToKey","ChainID","Mainnet","Testnet","address","chainId","StacksTestnet","hasAppPrivateKey","defaults","getStxAddress","postConditions","map","bytesToHex","serializePostCondition","pc","payload","encodePostConditions","tokenSigner","TokenSigner","signAsync","createUnsecuredToken","openTransactionPopup","token","provider","getStacksProvider","Error","transactionRequest","txResponse","txRaw","txBytes","hexToBytes","replace","stacksTransaction","deserializeTransaction","sponsored","onFinish","error","onCancel","makeContractCallToken","functionArgs","appDetails","_options","args","arg","serializeCV","payload2","txType","TransactionTypes","ContractCall","signPayload","createUnsignedTransactionPayload","makeContractDeployToken","ContractDeploy","makeSTXTransferToken","amount","toString","STXTransfer","makeTokenFn","getDefaults","generateTokenAndOpenPopup"],"mappings":"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"}